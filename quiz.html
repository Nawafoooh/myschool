<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, interactive-widget=resizes-content">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex, nofollow">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://www.gstatic.com https://*.firebaseio.com; object-src 'none'; base-uri 'none';">
  <title>Ù†Ø§ÙØ³ - Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</title>

  <!-- Preload critical CSS -->
  <link rel="preload" href="data:text/css;base64,Lyo9PT09PT09PT09PT09PT09PT0gUm9vdCBWYXJpYWJsZXMgPT09PT09PT09PT09PT09PT09PSovIDpSb290ey0tcHJpbWFyeTojNjM2NmYxOyAtLXN1Y2Nlc3M6IzEwYjk4MTsgLS1kYW5nZXI6I2VmNDQ0NDsgLXItcmFkaXVzOjI1cHg7IC0tc2hhZG93OjAgMTVweCA0MHB4IHJnYmEoOTksMTAyLDI0MSwuMTUpfSAvKj09PT09PT09PT09PT09PT09PSBCYXNlID09PT09PT09PT09PT09PT09PT0qLyAqeyBtYXJnaW46MDsgcGFkZGluZzowOyBib3gtc2l6aW5nOmJvcmRlci1ib3ggfSBodG1sLGJvZHl7IGRpcmVjdGlvbjpydGwsgZGlzcGxheTpmbGV4OyBmbGV4LWRpcmVjdGlvbjpjb2x1bW47IG1pbmgtaGVpZ2h0OjEwMHZofSBib2R5eyBmb250LWZhbWlseTonU2Vnb2UgVUknLFRhaG9tYSxHZW5ldmEsVmVyZGFuYSxzYW5zLXNlcmlmOyBiYWNrZ3JvdW5kOmxpbmVhci1ncmFkaWVudCgxMzVkZWcsIzY2N2VlYSAwJSwjNzY0YmEyIDEwMCUpOyB1c2VyLXNlbGVjdDpub25lOyBvdmVyZmxvdy14OmhpZGRlbiB9IC5oaWRkZW57IGRpc3BsYXk6bm9uZSFpbXBvcnRhbnQgfQ==" as="style" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><style>/* inlined critical css */</style></noscript>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6366f1">
  <style>
    /* ======== Critical CSS inlined ======== */
    .quiz-container{max-width:900px;margin:0 auto;padding:20px}
    .header{background:rgba(255,255,255,.98);border-radius:var(--radius);padding:30px;margin-bottom:25px;text-align:center;box-shadow:var(--shadow)}
    .quiz-title{font-size:3em;font-weight:900;background:linear-gradient(135deg,var(--primary),#8b5cf6);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .question-card{background:rgba(255,255,255,.98);border-radius:30px;padding:50px;margin-bottom:30px;box-shadow:var(--shadow)}
    .btn{background:linear-gradient(135deg,var(--primary),#4f46e5);color:#fff;border:none;padding:20px 45px;border-radius:30px;font-size:1.2em;font-weight:700;cursor:pointer;transition:.3s;text-transform:uppercase;letter-spacing:1px;min-width:200px}
    .btn:disabled{background:linear-gradient(135deg,#9ca3af,#6b7280);cursor:not-allowed}
    .loading-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:flex;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(5px)}
    .loading-content{background:#fff;padding:40px;border-radius:20px;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,.3)}
    .loading-spinner{width:60px;height:60px;border:6px solid #f3f4f6;border-top:6px solid var(--primary);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©...</h3>
      <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹</p>
    </div>
  </div>

  <!-- Save Confirmation Modal -->
  <div class="loading-overlay hidden" id="saveConfirmation">
    <div class="save-confirmation">
      <h3>ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ø®Ø±ÙˆØ¬</h3>
      <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ ØªÙ‚Ø¯Ù…Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©ØŸ<br>
      <strong>Ø³ÙŠØªÙ… Ø­ÙØ¸:</strong><br>
      âœ… Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙ†Ù‚Ø§Ø·Ùƒ<br>
      âœ… Ø¥Ø¬Ø§Ø¨Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©<br>
      âœ… Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ<br><br>
      ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙˆØ§Ø³ØªÙƒÙ…Ø§Ù„ Ù…Ù† Ù†ÙØ³ Ø§Ù„Ù†Ù‚Ø·Ø©.</p>
      <div class="action-buttons">
        <button class="btn btn-save" id="confirmSaveBtn">âœ… Ù†Ø¹Ù…ØŒ Ø§Ø­ÙØ¸ ÙˆØ§Ø®Ø±Ø¬</button>
        <button class="btn btn-secondary" id="cancelSaveBtn">âŒ Ø¥Ù„ØºØ§Ø¡ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="quiz-container">
    <div class="header">
      <div class="ministry-info">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… â€¢ Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</div>
      <h1 class="quiz-title">ğŸ† Ù…Ø³Ø§Ø¨Ù‚Ø© Ù†Ø§ÙØ³ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</h1>
      <div class="student-info">
        <span id="studentIcon">ğŸ‘¤</span>
        <strong>Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> <span id="studentName">Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯</span> â€¢ 
        <strong>Ø§Ù„ØµÙ:</strong> <span id="studentGrade">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·</span> â€¢ 
        <span id="studentSection">Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£</span>
      </div>
    </div>

    <div class="progress-section">
      <div class="progress-header">
        <div class="question-counter" id="questionCounter">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 10</div>
        <div class="timer-container">
          <div class="timer" id="timer">â° 60</div>
          <div class="score-display" id="scoreDisplay">Ø§Ù„Ù†Ù‚Ø§Ø·: 0</div>
        </div>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width:10%"></div>
      </div>
      <div class="progress-text" id="progressText">ØªÙ‚Ø¯Ù…Ùƒ: 10% â€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: 9 Ø£Ø³Ø¦Ù„Ø©</div>
    </div>

    <div class="question-card" id="questionCard">
      <div class="question-header">
        <div class="question-icon">ğŸ¤”</div>
        <div>
          <div class="question-category" id="questionCategory">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</div>
          <div class="question-difficulty" id="questionDifficulty">â­â­ Ù…ØªÙˆØ³Ø·</div>
        </div>
      </div>
      <div class="question-text" id="questionText">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„...</div>
      <div class="options-container" id="optionsContainer"></div>
      <div class="message-container" id="messageContainer"></div>
      <div class="action-buttons">
        <button class="btn" id="submitBtn" disabled>âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
        <button class="btn hidden" id="nextBtn">â­ï¸ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <button class="btn btn-warning" id="skipBtn">â­ï¸ ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„</button>
        <button class="btn btn-save" id="saveExitBtn">ğŸ’¾ Ø­ÙØ¸ ÙˆØ®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div class="completion-card hidden" id="completionCard">
      <h2>ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ù„Ù‚Ø¯ Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h2>
      <div class="final-score" id="finalScore">0/100</div>
      <p>ğŸŒŸ Ø£Ø¯Ø§Ø¡ Ø±Ø§Ø¦Ø¹! Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬...</p>
    </div>

    <div class="footer-credit">
      <div class="supervisor">ØªØµÙ…ÙŠÙ… ÙˆØªÙ†ÙÙŠØ°: Ù†ÙˆØ§Ù Ø§Ù„ØµØ¨Ø­ÙŠ</div>
      <div class="school">Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</div>
    </div>
  </div>

  <script>
    /* ========== Security First ========== */
    window.eval = null;
    window.open = null;
    console.clear = () => {};
    document.addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('selectstart', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I','J','C'].includes(e.key.toUpperCase()))) {
        e.preventDefault();
      }
    });
  </script>

  <!-- Core Module -->
  <script type="module">
    // ============== Firebase Config ==============
    const firebaseConfig = {
      apiKey: "AIzaSyA5yepZwrOlqFiV_KkVHp9dBaaT65pgdRo",
      authDomain: "nafs-competition.firebaseapp.com",
      projectId: "nafs-competition",
      storageBucket: "nafs-competition.firebasestorage.app",
      messagingSenderId: "182205828634",
      appId: "1:182205828634:web:dee889f770eb52ff668ba3"
    };

    // ============== Conditional Firebase Import ==============
    let db = null, auth = null;
    if (navigator.onLine) {
      try {
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getAuth, signInAnonymously } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const { getFirestore, doc, setDoc, updateDoc, query, where, getDocs, orderBy, limit, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        console.log('âœ… Firebase modules loaded');
      } catch (e) {
        console.warn('âš ï¸ Firebase failed, running offline');
      }
    }

    // ============== SafeStorage ==============
    const SafeStorage = {
      _memory: {},
      setItem(k, v) {
        try { if (typeof sessionStorage !== 'undefined') sessionStorage.setItem(k, v); else this._memory[k] = v; return true; } catch { this._memory[k] = v; }
      },
      getItem(k) {
        try { if (typeof sessionStorage !== 'undefined') return sessionStorage.getItem(k); } catch {} return this._memory[k] || null;
      },
      removeItem(k) {
        try { if (typeof sessionStorage !== 'undefined') sessionStorage.removeItem(k); } catch {} delete this._memory[k];
      }
    };

    // ============== AppState ==============
    const AppState = {
      currentQuestionIndex: 0,
      selectedAnswer: null,
      score: 0,
      timeLeft: 60,
      timerInterval: null,
      sessionCompleted: false,
      questionStartTime: Date.now(),
      currentQuestions: [],
      studentData: null,
      sessionId: null,
      isPaused: false,
      isSubmitting: false
    };

    // ============== SessionManager ==============
    class SessionManager {
      constructor() { this.studentData = null; this.isSessionValid = false; this.sessionTimeout = 7 * 24 * 60 * 60 * 1000; }
      validateSession() {
        const saved = SafeStorage.getItem('nafes_student_data');
        if (!saved) return false;
        try {
          this.studentData = JSON.parse(saved);
          if (!this.studentData?.studentId || !this.studentData?.fullName) return false;
          if (Date.now() - (this.studentData.timestamp || 0) > this.sessionTimeout) { this.clearSession(); return false; }
          this.isSessionValid = true;
          AppState.studentData = this.studentData;
          return true;
        } catch { this.clearSession(); return false; }
      }
      updateStudentDisplay() {
        if (!this.studentData) return;
        document.getElementById('studentName').textContent = this.studentData.fullName;
        document.getElementById('studentGrade').textContent = this.studentData.grade;
        document.getElementById('studentSection').textContent = `Ø§Ù„Ø´Ø¹Ø¨Ø© ${this.studentData.section}`;
        document.getElementById('studentIcon').textContent = this.studentData.icon;
      }
      saveQuizProgress(progress) {
        try {
          const data = { ...progress, studentId: this.studentData.studentId, timestamp: Date.now() };
          SafeStorage.setItem('nafes_quiz_progress', JSON.stringify(data));
          return true;
        } catch { return false; }
      }
      loadQuizProgress() {
        try {
          const saved = SafeStorage.getItem('nafes_quiz_progress');
          if (!saved) return null;
          const progress = JSON.parse(saved);
          if (progress.studentId !== this.studentData.studentId) return null;
          if (Date.now() - (progress.timestamp || 0) > this.sessionTimeout) { this.clearQuizProgress(); return null; }
          return progress;
        } catch { this.clearQuizProgress(); return null; }
      }
      clearQuizProgress() { SafeStorage.removeItem('nafes_quiz_progress'); }
      clearSession() { SafeStorage.removeItem('nafes_student_data'); SafeStorage.removeItem('nafes_quiz_progress'); this.studentData = null; this.isSessionValid = false; }
    }

    // ============== QuestionManager ==============
    class QuestionManager {
      constructor() { this.questions = []; }
      async loadQuestions() {
        console.log('ğŸ”„ Loading questions...');
        if (db) {
          try {
            const q = query(collection(db, 'questions'), where('isActive', '==', true), limit(10));
            const snap = await getDocs(q);
            if (!snap.empty) {
              this.questions = [];
              snap.forEach(doc => { const d = doc.data(); this.questions.push({ id: doc.id, category: d.category, difficulty: d.difficulty, text: d.text, options: d.options, correct: d.correct, points: d.points || 10 }); });
              this.questions = this.shuffleArray(this.questions);
              console.log('âœ… Firebase questions loaded'); return;
            }
          } catch (e) { console.warn('âš ï¸ Firebase failed, fallback to local'); }
        }
        this.questions = this.getLocalQuestions(); this.questions = this.shuffleArray(this.questions);
        console.log('âœ… Local questions loaded');
      }
      getLocalQuestions() {
        return [
          { id: "local_1", category: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", difficulty: "Ù…ØªÙˆØ³Ø·", text: "Ù…Ø§ Ù†Ø§ØªØ¬ 15 + 27ØŸ", options: ["40", "42", "45", "38"], correct: 1, points: 10 },
          { id: "local_2", category: "Ø§Ù„Ø¹Ù„ÙˆÙ…", difficulty: "Ø³Ù‡Ù„", text: "ÙƒÙ… Ø¹Ø¯Ø¯ ÙƒÙˆØ§ÙƒØ¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©ØŸ", options: ["7", "8", "9", "10"], correct: 1, points: 10 },
          { id: "local_3", category: "Ø§Ù„ØªØ§Ø±ÙŠØ®", difficulty: "Ù…ØªÙˆØ³Ø·", text: "ÙÙŠ Ø£ÙŠ Ø¹Ø§Ù… ØªØ£Ø³Ø³Øª Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŸ", options: ["1930", "1932", "1935", "1940"], correct: 1, points: 10 },
          { id: "local_4", category: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", difficulty: "Ø³Ù‡Ù„", text: "Ù…Ø§ Ø¥Ø¹Ø±Ø§Ø¨ ÙƒÙ„Ù…Ø© 'Ù…Ø­Ù…Ø¯' ÙÙŠ Ø¬Ù…Ù„Ø© 'Ø¬Ø§Ø¡ Ù…Ø­Ù…Ø¯'ØŸ", options: ["Ù…Ø¨ØªØ¯Ø£", "ÙØ§Ø¹Ù„", "Ù…ÙØ¹ÙˆÙ„ Ø¨Ù‡", "Ø®Ø¨Ø±"], correct: 1, points: 10 },
          { id: "local_5", category: "Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§", difficulty: "Ù…ØªÙˆØ³Ø·", text: "Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŸ", options: ["Ø¬Ø¯Ø©", "Ø§Ù„Ø¯Ù…Ø§Ù…", "Ø§Ù„Ø±ÙŠØ§Ø¶", "Ù…ÙƒØ©"], correct: 2, points: 10 },
          { id: "local_6", category: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª", difficulty: "ØµØ¹Ø¨", text: "Ù…Ø§ Ù†Ø§ØªØ¬ 12 Ã— 15ØŸ", options: ["170", "180", "185", "190"], correct: 1, points: 15 },
          { id: "local_7", category: "Ø§Ù„Ø¹Ù„ÙˆÙ…", difficulty: "Ù…ØªÙˆØ³Ø·", text: "Ù…Ø§ Ù‡Ùˆ Ø§Ù„ØºØ§Ø² Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ù†ØªØ´Ø§Ø±Ø§Ù‹ ÙÙŠ Ø§Ù„ØºÙ„Ø§Ù Ø§Ù„Ø¬ÙˆÙŠØŸ", options: ["Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†", "Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ†", "Ø«Ø§Ù†ÙŠ Ø£ÙƒØ³ÙŠØ¯ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†", "Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆØ¬ÙŠÙ†"], correct: 1, points: 10 },
          { id: "local_8", category: "Ø§Ù„Ø¯ÙŠÙ†", difficulty: "Ø³Ù‡Ù„", text: "ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ØŸ", options: ["4", "5", "6", "7"], correct: 1, points: 10 },
          { id: "local_9", category: "Ø§Ù„ØªØ§Ø±ÙŠØ®", difficulty: "ØµØ¹Ø¨", text: "Ù…Ù† Ù‡Ùˆ Ù…Ø¤Ø³Ø³ Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŸ", options: ["Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø³Ø¹ÙˆØ¯", "Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø¢Ù„ Ø³Ø¹ÙˆØ¯", "ØªØ±ÙƒÙŠ Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡", "ÙÙŠØµÙ„ Ø¨Ù† ØªØ±ÙƒÙŠ"], correct: 0, points: 15 },
          { id: "local_10", category: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©", difficulty: "Ù…ØªÙˆØ³Ø·", text: "Ù…Ø§ Ù…Ø¹Ù†Ù‰ ÙƒÙ„Ù…Ø© 'ØµØ¨Ø±' ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŸ", options: ["Ø§Ù„ØªØ­Ù…Ù„", "Ø§Ù„Ø³Ø±Ø¹Ø©", "Ø§Ù„Ù‚ÙˆØ©", "Ø§Ù„Ø­ÙƒÙ…Ø©"], correct: 0, points: 10 }
        ];
      }
      shuffleArray(arr) { const a = [...arr]; for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } return a; }
      getCurrentQuestion() { return this.questions[AppState.currentQuestionIndex]; }
      getTotalQuestions() { return this.questions.length; }
    }

    // ============== TimerManager ==============
    class TimerManager {
      constructor() { this.timerElement = document.getElementById('timer'); }
      start() {
        this.stop();
        AppState.timerInterval = setInterval(() => {
          if (!AppState.isPaused) {
            AppState.timeLeft--;
            this.updateDisplay();
            if (AppState.timeLeft <= 0) { this.stop(); quizController.handleTimeUp(); }
          }
        }, 1000);
      }
      stop() { if (AppState.timerInterval) { clearInterval(AppState.timerInterval); AppState.timerInterval = null; } }
      updateDisplay() {
        if (!this.timerElement) return;
        this.timerElement.textContent = `â° ${AppState.timeLeft}`;
        this.timerElement.className = 'timer';
        if (AppState.timeLeft <= 10) this.timerElement.classList.add('critical');
        else if (AppState.timeLeft <= 20) this.timerElement.classList.add('warning');
      }
      reset(seconds = 60) {
        AppState.timeLeft = seconds;
        this.timerElement.classList.remove('warning', 'critical');
        this.updateDisplay();
      }
    }

    // ============== UIManager ==============
    class UIManager {
      constructor() {
        this.elements = {
          questionCounter: document.getElementById('questionCounter'),
          questionCategory: document.getElementById('questionCategory'),
          questionDifficulty: document.getElementById('questionDifficulty'),
          questionText: document.getElementById('questionText'),
          optionsContainer: document.getElementById('optionsContainer'),
          progressFill: document.getElementById('progressFill'),
          progressText: document.getElementById('progressText'),
          scoreDisplay: document.getElementById('scoreDisplay'),
          messageContainer: document.getElementById('messageContainer'),
          submitBtn: document.getElementById('submitBtn'),
          nextBtn: document.getElementById('nextBtn'),
          skipBtn: document.getElementById('skipBtn'),
          saveExitBtn: document.getElementById('saveExitBtn'),
          questionCard: document.getElementById('questionCard'),
          completionCard: document.getElementById('completionCard'),
          finalScore: document.getElementById('finalScore')
        };
      }
      showLoading(show) { document.getElementById('loadingOverlay').classList.toggle('hidden', !show); }
      showSaveConfirmation() { document.getElementById('saveConfirmation').classList.remove('hidden'); }
      hideSaveConfirmation() { document.getElementById('saveConfirmation').classList.add('hidden'); }
      loadQuestion(question, idx, total) {
        if (!question) return;
        if (this.elements.questionCounter) this.elements.questionCounter.textContent = `Ø§Ù„Ø³Ø¤Ø§Ù„ ${idx + 1} Ù…Ù† ${total}`;
        if (this.elements.questionCategory) this.elements.questionCategory.textContent = question.category || 'Ø¹Ø§Ù…';
        if (this.elements.questionDifficulty) this.elements.questionDifficulty.innerHTML = this.getDifficultyStars(question.difficulty) + ' ' + question.difficulty;
        if (this.elements.questionText) this.elements.questionText.textContent = question.text;
        this.loadOptions(question);
        this.resetQuestionState();
        this.updateProgress(idx, total);
        this.updateScoreDisplay();
      }
      loadOptions(question) {
        if (!this.elements.optionsContainer) return;
        this.elements.optionsContainer.innerHTML = '';
        const letters = ['Ø£', 'Ø¨', 'Ø¬', 'Ø¯'];
        question.options.forEach((opt, i) => {
          const div = document.createElement('div');
          div.className = 'option';
          div.dataset.index = i;
          div.innerHTML = `<div class="option-letter">${letters[i]}</div><div class="option-text">${opt}</div>`;
          div.style.opacity = '0';
          div.style.transform = 'translateY(20px)';
          this.elements.optionsContainer.appendChild(div);
          setTimeout(() => {
            div.style.transition = 'all 0.6s ease';
            div.style.opacity = '1';
            div.style.transform = 'translateY(0)';
          }, i * 100);
        });
      }
      updateProgress(current, total) {
        const progress = ((current + 1) / total) * 100;
        if (this.elements.progressFill) this.elements.progressFill.style.width = `${progress}%`;
        if (this.elements.progressText) this.elements.progressText.textContent = `ØªÙ‚Ø¯Ù…Ùƒ: ${Math.round(progress)}% â€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${total - current - 1} Ø³Ø¤Ø§Ù„`;
      }
      updateScoreDisplay() { if (this.elements.scoreDisplay) this.elements.scoreDisplay.textContent = `Ø§Ù„Ù†Ù‚Ø§Ø·: ${AppState.score}`; }
      resetQuestionState() {
        AppState.selectedAnswer = null;
        AppState.isPaused = false;
        if (this.elements.submitBtn) {
          this.elements.submitBtn.disabled = true;
          this.elements.submitBtn.classList.remove('hidden');
        }
        if (this.elements.nextBtn) this.elements.nextBtn.classList.add('hidden');
        if (this.elements.skipBtn) this.elements.skipBtn.classList.remove('hidden');
        if (this.elements.saveExitBtn) this.elements.saveExitBtn.classList.remove('hidden');
        if (this.elements.messageContainer) this.elements.messageContainer.innerHTML = '';
        document.querySelectorAll('.option').forEach(opt => {
          opt.classList.remove('selected', 'correct', 'incorrect');
          opt.style.pointerEvents = 'auto';
        });
      }
      selectAnswer(optionElement) {
        document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
        optionElement.classList.add('selected');
        AppState.selectedAnswer = parseInt(optionElement.dataset.index);
        if (this.elements.submitBtn) this.elements.submitBtn.disabled = false;
      }
      showAnswerResults(question, isCorrect) {
        document.querySelectorAll('.option').forEach((opt, idx) => {
          if (idx === question.correct) opt.classList.add('correct');
          if (idx === AppState.selectedAnswer && !isCorrect) opt.classList.add('incorrect');
        });
      }
      updateControlButtons() {
        if (this.elements.submitBtn) this.elements.submitBtn.classList.add('hidden');
        if (this.elements.skipBtn) this.elements.skipBtn.classList.add('hidden');
        if (this.elements.saveExitBtn) this.elements.saveExitBtn.classList.add('hidden');
        if (this.elements.nextBtn) this.elements.nextBtn.classList.remove('hidden');
      }
      showMessage(type, text) {
        if (this.elements.messageContainer) this.elements.messageContainer.innerHTML = `<div class="message ${type}">${text}</div>`;
      }
      showCompletionCard() {
        const total = AppState.currentQuestions.reduce((s, q) => s + (q.points || 10), 0);
        if (this.elements.finalScore) this.elements.finalScore.textContent = `${AppState.score}/${total}`;
        if (this.elements.completionCard) this.elements.completionCard.classList.remove('hidden');
        if (this.elements.questionCard) this.elements.questionCard.classList.add('hidden');
      }
      getDifficultyStars(difficulty) { return difficulty === 'Ø³Ù‡Ù„' ? 'â­' : difficulty === 'ØµØ¹Ø¨' ? 'â­â­â­' : 'â­â­'; }
    }

    // ============== QuizController ==============
    class QuizController {
      constructor() {
        this.sessionManager = new SessionManager();
        this.questionManager = new QuestionManager();
        this.timerManager = new TimerManager();
        this.uiManager = new UIManager();
      }
      async start() {
        try {
          this.uiManager.showLoading(true);
          if (!this.sessionManager.validateSession()) { window.location.href = 'index.html'; return; }
          this.sessionManager.updateStudentDisplay();

          if (db && auth) await signInAnonymously(auth);

          await this.questionManager.loadQuestions();
          AppState.currentQuestions = this.questionManager.questions;

          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('resume')) await this.restoreLastSession();
          else await this.checkExistingProgress();

          this.setupEventListeners();
          this.setupSecurity();

          if (!AppState.sessionCompleted) {
            this.loadCurrentQuestion();
            this.timerManager.start();
          }

          this.uiManager.showLoading(false);
          this.uiManager.showMessage('success', 'ğŸš€ ØªÙ… ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­! Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†');
        } catch (error) {
          console.error('âŒ Initialization failed:', error);
          this.uiManager.showLoading(false);
          this.showFallback();
        }
      }
      async restoreLastSession() {
        const progress = this.sessionManager.loadQuizProgress();
        if (!progress) { this.uiManager.showMessage('error', 'âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù'); return; }
        AppState.currentQuestionIndex = progress.currentQuestionIndex || 0;
        AppState.score = progress.score || 0;
        AppState.timeLeft = progress.timeLeft || 60;
        AppState.selectedAnswer = progress.selectedAnswer ?? null;
        this.loadCurrentQuestion();
        this.uiManager.updateScoreDisplay();
        this.timerManager.updateDisplay();
        this.uiManager.showMessage('success', 'ğŸ”„ ØªÙ… Ø§Ø³ØªØ¦Ù†Ø§Ù Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…Ù† Ø¢Ø®Ø± Ù†Ù‚Ø·Ø© ØªÙˆÙ‚Ù!');
      }
      async checkExistingProgress() {
        const progress = this.sessionManager.loadQuizProgress();
        if (progress) { this.restoreProgress(progress); this.uiManager.showMessage('info', 'ğŸ“ ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© ØªÙ‚Ø¯Ù…Ùƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸!'); return; }
        AppState.sessionId = `session_${AppState.studentData.studentId}_${Date.now()}`;
      }
      restoreProgress(progress) {
        AppState.currentQuestionIndex = progress.currentQuestionIndex || 0;
        AppState.score = progress.score || 0;
        AppState.timeLeft = progress.timeLeft || 60;
        AppState.selectedAnswer = progress.selectedAnswer ?? null;
      }
      loadCurrentQuestion() {
        if (AppState.currentQuestionIndex >= this.questionManager.getTotalQuestions()) { this.completeSession(); return; }
        const question = this.questionManager.getCurrentQuestion();
        if (!question) return;
        AppState.questionStartTime = Date.now();
        this.uiManager.loadQuestion(question, AppState.currentQuestionIndex, this.questionManager.getTotalQuestions());
        if (AppState.timeLeft <= 0) this.timerManager.reset();
      }
      async saveProgress() {
        const progress = {
          currentQuestionIndex: AppState.currentQuestionIndex,
          score: AppState.score,
          timeLeft: AppState.timeLeft,
          selectedAnswer: AppState.selectedAnswer,
          answers: AppState.currentQuestions.map((q, i) => ({ questionId: q.id, selected: i === AppState.currentQuestionIndex ? AppState.selectedAnswer : null, correct: q.correct })),
          lastUpdate: new Date().toISOString()
        };
        this.sessionManager.saveQuizProgress(progress);
        if (db && AppState.sessionId) {
          try {
            const ref = doc(db, 'quiz_sessions', AppState.sessionId);
            await setDoc(ref, { ...progress, lastUpdate: serverTimestamp() }, { merge: true });
            console.log('âœ… Saved to Firestore');
          } catch (e) { console.warn('âš ï¸ Cloud save failed, kept locally'); }
        }
        this.uiManager.showMessage('success', 'ğŸ’¾ ØªÙ… Ø­ÙØ¸ ØªÙ‚Ø¯Ù…Ùƒ Ø¨Ù†Ø¬Ø§Ø­!');
      }
      async saveAndExit() {
        if (AppState.isSubmitting) return;
        AppState.isSubmitting = true;
        this.uiManager.showLoading(true);
        await this.saveProgress();
        this.uiManager.hideSaveConfirmation();
        setTimeout(() => window.location.href = 'index.html?resume=true', 1500);
      }
      async submitAnswer() {
        if (AppState.selectedAnswer === null || AppState.isPaused) return;
        AppState.isPaused = true;
        this.timerManager.stop();
        const question = this.questionManager.getCurrentQuestion();
        const isCorrect = AppState.selectedAnswer === question.correct;
        this.uiManager.showAnswerResults(question, isCorrect);
        if (isCorrect) {
          AppState.score += question.points || 10;
          this.uiManager.updateScoreDisplay();
          this.uiManager.showMessage('success', this.getRandomSuccessMessage());
        } else {
          this.uiManager.showMessage('error', this.getRandomErrorMessage());
        }
        this.uiManager.updateControlButtons();
        await this.saveProgress();
        setTimeout(() => this.nextQuestion(), 3000);
      }
      async skipQuestion() {
        if (AppState.isPaused) return;
        AppState.isPaused = true;
        this.timerManager.stop();
        const question = this.questionManager.getCurrentQuestion();
        this.uiManager.showMessage('info', 'â­ ØªÙ… ØªØ®Ø·ÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„! Ù„Ø§ ØªÙ‚Ù„Ù‚ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹ÙˆÙŠØ¶ ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©!');
        document.querySelectorAll('.option').forEach((opt, idx) => {
          if (idx === question.correct) opt.classList.add('correct');
          opt.style.pointerEvents = 'none';
        });
        this.uiManager.updateControlButtons();
        await this.saveProgress();
        setTimeout(() => this.nextQuestion(), 2500);
      }
      nextQuestion() {
        AppState.currentQuestionIndex++;
        document.querySelectorAll('.option').forEach(opt => {
          opt.style.pointerEvents = 'auto';
          opt.classList.remove('selected', 'correct', 'incorrect');
        });
        if (AppState.currentQuestionIndex >= this.questionManager.getTotalQuestions()) this.completeSession();
        else { this.loadCurrentQuestion(); this.timerManager.start(); }
      }
      handleTimeUp() {
        if (AppState.isPaused) return;
        AppState.isPaused = true;
        const question = this.questionManager.getCurrentQuestion();
        this.uiManager.showMessage('error', 'â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª! Ù„Ø§ ØªÙ‚Ù„Ù‚ØŒ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø£ÙØ¶Ù„!');
        document.querySelectorAll('.option').forEach((opt, idx) => {
          if (idx === question.correct) opt.classList.add('correct');
          opt.style.pointerEvents = 'none';
        });
        this.uiManager.updateControlButtons();
        this.saveProgress();
        setTimeout(() => this.nextQuestion(), 2500);
      }
      async completeSession() {
        AppState.sessionCompleted = true;
        this.timerManager.stop();
        const total = AppState.currentQuestions.reduce((s, q) => s + (q.points || 10), 0);
        const percentage = Math.round((AppState.score / total) * 100);
        if (db && AppState.sessionId) {
          try {
            const ref = doc(db, 'quiz_sessions', AppState.sessionId);
            await setDoc(ref, {
              completed: true,
              score: AppState.score,
              percentage,
              totalQuestions: this.questionManager.getTotalQuestions(),
              timeSpent: this.questionManager.getTotalQuestions() * 60 - AppState.timeLeft,
              lastUpdate: serverTimestamp()
            }, { merge: true });
          } catch (e) { console.warn('âš ï¸ Final cloud save failed'); }
        }
        this.sessionManager.clearQuizProgress();
        this.uiManager.showCompletionCard();
        setTimeout(() => window.location.href = 'leaderboard.html', 4000);
      }
      setupEventListeners() {
        document.addEventListener('click', e => {
          if (e.target.closest('.option') && !AppState.sessionCompleted && !AppState.isPaused) {
            const option = e.target.closest('.option');
            if (!option.classList.contains('correct') && !option.classList.contains('incorrect')) this.uiManager.selectAnswer(option);
          }
        });
        this.uiManager.elements.submitBtn?.addEventListener('click', () => this.submitAnswer());
        this.uiManager.elements.nextBtn?.addEventListener('click', () => this.nextQuestion());
        this.uiManager.elements.skipBtn?.addEventListener('click', () => this.skipQuestion());
        this.uiManager.elements.saveExitBtn?.addEventListener('click', () => this.uiManager.showSaveConfirmation());
        document.getElementById('confirmSaveBtn')?.addEventListener('click', () => this.saveAndExit());
        document.getElementById('cancelSaveBtn')?.addEventListener('click', () => this.uiManager.hideSaveConfirmation());
        document.addEventListener('keydown', e => {
          if (AppState.sessionCompleted || AppState.isPaused) return;
          if (e.key >= '1' && e.key <= '4') {
            const idx = parseInt(e.key) - 1;
            const opt = document.querySelector(`[data-index="${idx}"]`);
            if (opt && !opt.classList.contains('correct') && !opt.classList.contains('incorrect')) this.uiManager.selectAnswer(opt);
          } else if (e.key === 'Enter' && AppState.selectedAnswer !== null) this.submitAnswer();
          else if (e.key === 'Escape') this.skipQuestion();
          else if (e.ctrlKey && e.key.toLowerCase() === 's') { e.preventDefault(); this.saveAndExit(); }
        });
        window.addEventListener('beforeunload', e => {
          if (!AppState.sessionCompleted && AppState.currentQuestionIndex > 0 && !AppState.isPaused) {
            e.preventDefault();
            e.returnValue = 'Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ù‚Ø§Ù‹ ØªØ±Ùƒ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©ØŸ Ù„Ù… ÙŠØªÙ… Ø­ÙØ¸ ØªÙ‚Ø¯Ù…Ùƒ Ø¨Ø¹Ø¯. Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "Ø­ÙØ¸ ÙˆØ®Ø±ÙˆØ¬" Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ø¢Ù…Ù†.';
            return e.returnValue;
          }
        });
        window.addEventListener('beforeunload', () => { if (AppState.timerInterval) clearInterval(AppState.timerInterval); });
      }
      setupSecurity() {
        document.addEventListener('keydown', e => {
          if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && ['I', 'J', 'C'].includes(e.key.toUpperCase())) || (e.ctrlKey && ['u', 'U', 'a', 'A', 'c', 'C', 'v', 'V'].includes(e.key.toLowerCase()))) {
            e.preventDefault();
            this.uiManager.showMessage('error', 'âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©!');
            return false;
          }
        });
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('selectstart', e => e.preventDefault());
      }
      getRandomSuccessMessage() {
        const msgs = ["ğŸŒŸ Ù…Ù…ØªØ§Ø²! Ø¥Ø¬Ø§Ø¨Ø© ØµØ­ÙŠØ­Ø© ØªÙ…Ø§Ù…Ø§Ù‹!", "ğŸš€ Ø±Ø§Ø¦Ø¹! Ø£Ù†Øª ØªØªÙ‚Ø¯Ù… Ø¨Ø«Ø¨Ø§Øª!", "ğŸ† Ø£Ø­Ø³Ù†Øª! ÙˆØ§ØµÙ„ Ù‡Ø°Ø§ Ø§Ù„ØªÙ…ÙŠØ²!", "â­ Ø¹Ø¨Ù‚Ø±ÙŠ! Ø¥Ø¬Ø§Ø¨Ø© Ù…Ø«Ø§Ù„ÙŠØ©!", "ğŸ¯ Ø¯Ù‚ÙŠÙ‚ Ø¬Ø¯Ø§Ù‹! Ø£Ù†Øª Ù…Ø­ØªØ±Ù!"];
        return msgs[Math.floor(Math.random() * msgs.length)];
      }
      getRandomErrorMessage() {
        const msgs = ["ğŸ’ª Ù„Ø§ ØªÙŠØ£Ø³! Ø§Ù„ØªØ¹Ù„Ù… Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù‚ÙˆØ©!", "ğŸŒ± ÙƒÙ„ Ø®Ø·Ø£ Ø®Ø·ÙˆØ© Ù†Ø­Ùˆ Ø§Ù„ØªÙÙˆÙ‚!", "ğŸ”„ Ù„Ø§ Ø¨Ø£Ø³! Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø³ØªÙƒÙˆÙ† Ø£ÙØ¶Ù„!", "ğŸŒŸ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø·Ø±ÙŠÙ‚ Ø§Ù„Ù†Ø¬Ø§Ø­! ØªÙ‚Ø¯Ù… Ù„Ù„Ø£Ù…Ø§Ù…!"];
        return msgs[Math.floor(Math.random() * msgs.length)];
      }
      showFallback() {
        this.uiManager.showMessage('error', 'âš ï¸ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø§ØªØµØ§Ù„Ùƒ Ø«Ù… Ø£Ø¹Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„.');
      }
    }

    // ============== Initialize App ==============
    const quizController = new QuizController();
    await quizController.start();

    // ============== Global Error Handlers ==============
    window.addEventListener('error', e => console.error('ğŸ’¥ Global error:', e.error));
    window.addEventListener('unhandledrejection', e => console.error('ğŸ’¥ Unhandled rejection:', e.reason));
  </script>
</body>
</html>
