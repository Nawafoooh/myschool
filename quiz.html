<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex,nofollow">
  <title>Ù†Ø§ÙØ³ â€“ Ù…Ø³Ø§Ø¨Ù‚Ø© Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</title>

  <!-- ========  Critical CSS (inlined)  ======== -->
  <style>
    :root{
      --primary:#6366f1;--success:#10b981;--danger:#ef4444;--radius:25px;
      --shadow:0 15px 40px rgba(99,102,241,.15);
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif}
    body{
      display:flex;flex-direction:column;min-height:100vh;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      user-select:none;color:#fff;
    }
    .hidden{display:none!important}
    .loading-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.85);
      display:flex;align-items:center;justify-content:center;z-index:9999;
    }
    .loading-content{
      background:#fff;color:#111;padding:40px;border-radius:var(--radius);
      text-align:center;box-shadow:var(--shadow);
    }
    .spinner{
      width:50px;height:50px;border:5px solid #f3f4f6;
      border-top-color:var(--primary);border-radius:50%;
      animation:spin 1s linear infinite;margin:0 auto 15px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    .quiz-container{max-width:900px;margin:0 auto;padding:20px}
    .header{
      background:rgba(255,255,255,.98);color:#111;border-radius:var(--radius);
      padding:30px;margin-bottom:25px;text-align:center;box-shadow:var(--shadow);
    }
    .quiz-title{
      font-size:2.4em;font-weight:900;
      background:linear-gradient(135deg,var(--primary),#8b5cf6);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .student-info{font-size:1.1em;margin-top:10px}
    .progress-section{background:rgba(255,255,255,.15);border-radius:var(--radius);padding:15px 20px;margin-bottom:25px}
    .progress-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-weight:700}
    .progress-bar{height:10px;background:rgba(255,255,255,.25);border-radius:10px;overflow:hidden}
    .progress-fill{height:100%;background:#fff;transition:width .4s}
    .progress-text{text-align:center;font-weight:600;font-size:1.05em}
    .question-card{
      background:rgba(255,255,255,.98);color:#111;border-radius:30px;
      padding:40px 30px;box-shadow:var(--shadow);
    }
    .question-header{display:flex;align-items:center;gap:15px;margin-bottom:20px}
    .question-icon{font-size:2em}
    .question-category{font-weight:700;font-size:1.1em}
    .question-difficulty{font-size:.9em;opacity:.8}
    .question-text{font-size:1.35em;margin-bottom:25px;line-height:1.6}
    .options-container{display:flex;flex-direction:column;gap:12px}
    .option{
      display:flex;align-items:center;gap:12px;padding:15px 20px;
      background:#f3f4f6;border-radius:15px;cursor:pointer;
      transition:background .25s;border:2px solid transparent;
    }
    .option:hover{background:#e5e7eb}
    .option.selected{background:var(--primary);color:#fff}
    .option.correct{background:var(--success);color:#fff;border-color:#10b981}
    .option.incorrect{background:var(--danger);color:#fff;border-color:#ef4444}
    .option-letter{
      width:36px;height:36px;border-radius:50%;background:#fff;color:var(--primary);
      display:grid;place-content:center;font-weight:700;font-size:1.1em;
    }
    .action-buttons{margin-top:30px;display:flex;gap:15px;flex-wrap:wrap;justify-content:center}
    .btn{
      border:none;padding:16px 36px;border-radius:30px;font-size:1.1em;font-weight:700;
      cursor:pointer;transition:.3s;text-transform:uppercase;letter-spacing:1px;
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:linear-gradient(135deg,var(--primary),#4f46e5);color:#fff}
    .btn-secondary{background:#e5e7eb;color:#111}
    .btn-warning{background:#f59e0b;color:#fff}
    .btn-save{background:linear-gradient(135deg,#10b981,#059669);color:#fff}
    .message{margin-top:20px;padding:12px 18px;border-radius:12px;font-weight:700}
    .message.success{background:var(--success);color:#fff}
    .message.error{background:var(--danger);color:#fff}
    .message.info{background:#3b82f6;color:#fff}
    .completion-card{text-align:center}
    .final-score{font-size:3.5em;font-weight:900;margin:15px 0}
    .footer-credit{margin-top:auto;text-align:center;padding:20px;font-size:.9em;opacity:.8}
    @media(max-width:600px){
      .quiz-title{font-size:2em}
      .question-text{font-size:1.15em}
      .btn{width:100%}
    }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6366f1">
</head>

<body>
  <!-- ===== Loading ===== -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©...</h3>
      <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ø§Ù‹</p>
    </div>
  </div>

  <!-- Save Confirmation -->
  <div class="loading-overlay hidden" id="saveConfirmation">
    <div class="loading-content">
      <h3>ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„Ø®Ø±ÙˆØ¬</h3>
      <p>Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­ÙØ¸ ØªÙ‚Ø¯Ù…Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©ØŸ</p>
      <div class="action-buttons">
        <button class="btn btn-save" id="confirmSaveBtn">âœ… Ù†Ø¹Ù…ØŒ Ø§Ø­ÙØ¸ ÙˆØ§Ø®Ø±Ø¬</button>
        <button class="btn btn-secondary" id="cancelSaveBtn">âŒ Ø¥Ù„ØºØ§Ø¡ ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</button>
      </div>
    </div>
  </div>

  <!-- ===== Container ===== -->
  <div class="quiz-container">
    <header class="header">
      <div class="ministry-info">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ… â€¢ Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</div>
      <h1 class="quiz-title">ğŸ† Ù…Ø³Ø§Ø¨Ù‚Ø© Ù†Ø§ÙØ³ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©</h1>
      <div class="student-info">
        <span id="stuIcon">ğŸ‘¤</span>
        <strong>Ø§Ù„Ø·Ø§Ù„Ø¨:</strong> <span id="stuName">Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯</span> â€¢ 
        <strong>Ø§Ù„ØµÙ:</strong> <span id="stuGrade">Ø§Ù„Ø«Ø§Ù„Ø« Ø§Ù„Ù…ØªÙˆØ³Ø·</span> â€¢ 
        <span id="stuSec">Ø§Ù„Ø´Ø¹Ø¨Ø© Ø£</span>
      </div>
    </header>

    <section class="progress-section">
      <div class="progress-header">
        <div id="qCounter">Ø§Ù„Ø³Ø¤Ø§Ù„ 1 Ù…Ù† 10</div>
        <div id="timer">â° 60</div>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:10%"></div></div>
      <div id="progressText">ØªÙ‚Ø¯Ù…Ùƒ: 10% â€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: 9 Ø£Ø³Ø¦Ù„Ø©</div>
    </section>

    <main class="question-card" id="qCard">
      <div class="question-header">
        <div class="question-icon">ğŸ¤”</div>
        <div>
          <div class="question-category" id="qCat">Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</div>
          <div class="question-difficulty" id="qDiff">â­â­ Ù…ØªÙˆØ³Ø·</div>
        </div>
      </div>
      <div class="question-text" id="qText">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„...</div>
      <div class="options-container" id="opts"></div>
      <div class="message" id="msg"></div>
      <div class="action-buttons">
        <button class="btn btn-primary" id="submitBtn" disabled>âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</button>
        <button class="btn btn-primary hidden" id="nextBtn">â­ï¸ Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <button class="btn btn-warning" id="skipBtn">â­ï¸ ØªØ®Ø·ÙŠ</button>
        <button class="btn btn-save" id="saveExitBtn">ğŸ’¾ Ø­ÙØ¸ ÙˆØ®Ø±ÙˆØ¬</button>
      </div>
    </main>

    <section class="completion-card hidden" id="finishCard">
      <h2>ğŸ‰ ØªÙ‡Ø§Ù†ÙŠÙ†Ø§! Ø£ÙƒÙ…Ù„Øª Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©</h2>
      <div class="final-score" id="finalScore">0/100</div>
      <p>Ø³ÙŠØªÙ… ØªÙˆØ¬ÙŠÙ‡Ùƒ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬...</p>
    </section>

    <footer class="footer-credit">
      <div>ØªØµÙ…ÙŠÙ… ÙˆØªÙ†ÙÙŠØ°: Ù†ÙˆØ§Ù Ø§Ù„ØµØ¨Ø­ÙŠ</div>
      <div>Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</div>
    </footer>
  </div>

  <script type="module">
    /* ========== Security Lock-down ========== */
    window.eval=null;window.open=null;console.clear=()=>{};
    ["contextmenu","selectstart","dragstart","keydown"].forEach(ev=>{
      document.addEventListener(ev,e=>{
        if(ev==="keydown"){
          if(["F12","U","I","J","C"].includes(e.key.toUpperCase())||
            (e.ctrlKey&&e.shiftKey&&["I","J","C"].includes(e.key.toUpperCase()))){
            e.preventDefault();
          }
        }else e.preventDefault();
      });
    });

    /* ========== App State ========== */
    const App={
      idx:0,score:0,time:60,sel:null,completed:!1,
      questions:[],timer:null,
      els:{
        loading:document.getElementById("loadingOverlay"),
        qCounter:document.getElementById("qCounter"),
        qCat    :document.getElementById("qCat"),
        qDiff   :document.getElementById("qDiff"),
        qText   :document.getElementById("qText"),
        opts    :document.getElementById("opts"),
        progress:document.getElementById("progressFill"),
        progText:document.getElementById("progressText"),
        timerEl :document.getElementById("timer"),
        msg     :document.getElementById("msg"),
        submit  :document.getElementById("submitBtn"),
        next    :document.getElementById("nextBtn"),
        skip    :document.getElementById("skipBtn"),
        saveExit:document.getElementById("saveExitBtn"),
        qCard   :document.getElementById("qCard"),
        finish  :document.getElementById("finishCard"),
        finalScore:document.getElementById("finalScore"),
        saveConf:document.getElementById("saveConfirmation")
      }
    };

    /* ========== Questions Bank ========== */
    const bank=[
      {cat:"Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª",diff:"Ù…ØªÙˆØ³Ø·",text:"Ù…Ø§ Ù†Ø§ØªØ¬ 15 + 27ØŸ",opts:["40","42","45","38"],ans:1,pts:10},
      {cat:"Ø§Ù„Ø¹Ù„ÙˆÙ…",diff:"Ø³Ù‡Ù„",text:"ÙƒÙ… Ø¹Ø¯Ø¯ ÙƒÙˆØ§ÙƒØ¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ©ØŸ",opts:["7","8","9","10"],ans:1,pts:10},
      {cat:"Ø§Ù„ØªØ§Ø±ÙŠØ®",diff:"Ù…ØªÙˆØ³Ø·",text:"ÙÙŠ Ø£ÙŠ Ø¹Ø§Ù… ØªØ£Ø³Ø³Øª Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŸ",opts:["1930","1932","1935","1940"],ans:1,pts:10},
      {cat:"Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",diff:"Ø³Ù‡Ù„",text:"Ù…Ø§ Ø¥Ø¹Ø±Ø§Ø¨ ÙƒÙ„Ù…Ø© 'Ù…Ø­Ù…Ø¯' ÙÙŠ Ø¬Ù…Ù„Ø© 'Ø¬Ø§Ø¡ Ù…Ø­Ù…Ø¯'ØŸ",opts:["Ù…Ø¨ØªØ¯Ø£","ÙØ§Ø¹Ù„","Ù…ÙØ¹ÙˆÙ„ Ø¨Ù‡","Ø®Ø¨Ø±"],ans:1,pts:10},
      {cat:"Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠØ§",diff:"Ù…ØªÙˆØ³Ø·",text:"Ù…Ø§ Ù‡ÙŠ Ø¹Ø§ØµÙ…Ø© Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©ØŸ",opts:["Ø¬Ø¯Ø©","Ø§Ù„Ø¯Ù…Ø§Ù…","Ø§Ù„Ø±ÙŠØ§Ø¶","Ù…ÙƒØ©"],ans:2,pts:10},
      {cat:"Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª",diff:"ØµØ¹Ø¨",text:"Ù…Ø§ Ù†Ø§ØªØ¬ 12 Ã— 15ØŸ",opts:["170","180","185","190"],ans:1,pts:15},
      {cat:"Ø§Ù„Ø¹Ù„ÙˆÙ…",diff:"Ù…ØªÙˆØ³Ø·",text:"Ù…Ø§ Ù‡Ùˆ Ø§Ù„ØºØ§Ø² Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ù†ØªØ´Ø§Ø±Ø§Ù‹ ÙÙŠ Ø§Ù„ØºÙ„Ø§Ù Ø§Ù„Ø¬ÙˆÙŠØŸ",opts:["Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†","Ø§Ù„Ù†ÙŠØªØ±ÙˆØ¬ÙŠÙ†","Ø«Ø§Ù†ÙŠ Ø£ÙƒØ³ÙŠØ¯ Ø§Ù„ÙƒØ±Ø¨ÙˆÙ†","Ø§Ù„Ù‡ÙŠØ¯Ø±ÙˆØ¬ÙŠÙ†"],ans:1,pts:10},
      {cat:"Ø§Ù„Ø¯ÙŠÙ†",diff:"Ø³Ù‡Ù„",text:"ÙƒÙ… Ø¹Ø¯Ø¯ Ø£Ø±ÙƒØ§Ù† Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ØŸ",opts:["4","5","6","7"],ans:1,pts:10},
      {cat:"Ø§Ù„ØªØ§Ø±ÙŠØ®",diff:"ØµØ¹Ø¨",text:"Ù…Ù† Ù‡Ùˆ Ù…Ø¤Ø³Ø³ Ø§Ù„Ø¯ÙˆÙ„Ø© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŸ",opts:["Ù…Ø­Ù…Ø¯ Ø¨Ù† Ø³Ø¹ÙˆØ¯","Ø¹Ø¨Ø¯Ø§Ù„Ø¹Ø²ÙŠØ² Ø¢Ù„ Ø³Ø¹ÙˆØ¯","ØªØ±ÙƒÙŠ Ø¨Ù† Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡","ÙÙŠØµÙ„ Ø¨Ù† ØªØ±ÙƒÙŠ"],ans:0,pts:15},
      {cat:"Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",diff:"Ù…ØªÙˆØ³Ø·",text:"Ù…Ø§ Ù…Ø¹Ù†Ù‰ ÙƒÙ„Ù…Ø© 'ØµØ¨Ø±' ÙÙŠ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©ØŸ",opts:["Ø§Ù„ØªØ­Ù…Ù„","Ø§Ù„Ø³Ø±Ø¹Ø©","Ø§Ù„Ù‚ÙˆØ©","Ø§Ù„Ø­ÙƒÙ…Ø©"],ans:0,pts:10}
    ];

    /* ========== Util ========== */
    const rand=(a)=>a[Math.floor(Math.random()*a.length)];
    const shuffle=(arr)=>{
      const a=[...arr];
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }return a;
    };

    /* ========== Timer ========== */
    const Timer={
      start(){
        Timer.stop();
        App.timer=setInterval(()=>{
          App.time--;
          App.els.timerEl.textContent=`â° ${App.time}`;
          if(App.time<=10)App.els.timerEl.classList.add("critical");
          if(App.time<=0){Timer.stop();handleTimeUp();}
        },1000);
      },
      stop(){clearInterval(App.timer);App.timer=null;}
    };

    /* ========== Render ========== */
    function loadQuestion(){
      if(App.idx>=App.questions.length){finish();return;}
      const q=App.questions[App.idx];
      App.els.qCounter.textContent=`Ø§Ù„Ø³Ø¤Ø§Ù„ ${App.idx+1} Ù…Ù† ${App.questions.length}`;
      App.els.qCat.textContent=q.cat;
      App.els.qDiff.textContent=(q.diff==="Ø³Ù‡Ù„"?"â­":q.diff==="ØµØ¹Ø¨"?"â­â­â­":"â­â­")+" "+q.diff;
      App.els.qText.textContent=q.text;
      App.els.opts.innerHTML="";
      const letters=["Ø£","Ø¨","Ø¬","Ø¯"];
      q.opts.forEach((opt,i)=>{
        const div=document.createElement("div");
        div.className="option";div.dataset.idx=i;
        div.innerHTML=`<div class="option-letter">${letters[i]}</div><div>${opt}</div>`;
        App.els.opts.appendChild(div);
      });
      resetState();
      updateProgress();
      Timer.reset();
      Timer.start();
    }
    function resetState(){
      App.sel=null;
      App.els.submit.disabled=true;
      App.els.next.classList.add("hidden");
      App.els.skip.classList.remove("hidden");
      App.els.saveExit.classList.remove("hidden");
      App.els.msg.textContent="";
      document.querySelectorAll(".option").forEach(o=>o.classList.remove("selected","correct","incorrect"));
    }
    function updateProgress(){
      const p=((App.idx+1)/App.questions.length)*100;
      App.els.progress.style.width=p+"%";
      App.els.progText.textContent=`ØªÙ‚Ø¯Ù…Ùƒ: ${Math.round(p)}% â€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${App.questions.length-App.idx-1} Ø³Ø¤Ø§Ù„`;
    }

    /* ========== Handlers ========== */
    function selectOption(el){
      document.querySelectorAll(".option").forEach(o=>o.classList.remove("selected"));
      el.classList.add("selected");
      App.sel=parseInt(el.dataset.idx);
      App.els.submit.disabled=false;
    }
    async function submit(){
      if(App.sel===null)return;
      Timer.stop();
      const q=App.questions[App.idx];
      const ok=App.sel===q.ans;
      document.querySelectorAll(".option").forEach((o,i)=>{
        if(i===q.ans)o.classList.add("correct");
        if(i===App.sel&&!ok)o.classList.add("incorrect");
      });
      if(ok){App.score+=q.pts;App.els.msg.className="message success";App.els.msg.textContent=rand(["ğŸŒŸ Ù…Ù…ØªØ§Ø²!","ğŸš€ Ø±Ø§Ø¦Ø¹!","ğŸ† Ø£Ø­Ø³Ù†Øª!","â­ Ø¹Ø¨Ù‚Ø±ÙŠ!","ğŸ¯ Ø¯Ù‚ÙŠÙ‚!"]);}
      else{App.els.msg.className="message error";App.els.msg.textContent=rand(["ğŸ’ª Ù„Ø§ ØªÙŠØ£Ø³!","ğŸŒ± Ø§Ù„ØªØ¹Ù„Ù… Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ù‚ÙˆØ©!","ğŸ”„ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰!"]);}
      App.els.submit.classList.add("hidden");
      App.els.skip.classList.add("hidden");
      App.els.saveExit.classList.add("hidden");
      App.els.next.classList.remove("hidden");
      setTimeout(()=>next(),2500);
    }
    async function skip(){
      Timer.stop();
      const q=App.questions[App.idx];
      document.querySelectorAll(".option").forEach((o,i)=>{if(i===q.ans)o.classList.add("correct");});
      App.els.msg.className="message info";App.els.msg.textContent="â­ ØªÙ… Ø§Ù„ØªØ®Ø·ÙŠ!";
      App.els.submit.classList.add("hidden");
      App.els.skip.classList.add("hidden");
      App.els.saveExit.classList.add("hidden");
      App.els.next.classList.remove("hidden");
      setTimeout(()=>next(),2000);
    }
    function handleTimeUp(){
      const q=App.questions[App.idx];
      document.querySelectorAll(".option").forEach((o,i)=>{if(i===q.ans)o.classList.add("correct");});
      App.els.msg.className="message error";App.els.msg.textContent="â° Ø§Ù†ØªÙ‡Ù‰ Ø§Ù„ÙˆÙ‚Øª!";
      App.els.submit.classList.add("hidden");
      App.els.skip.classList.add("hidden");
      App.els.saveExit.classList.add("hidden");
      App.els.next.classList.remove("hidden");
      setTimeout(()=>next(),2000);
    }
    function next(){
      App.idx++;
      loadQuestion();
    }
    function finish(){
      Timer.stop();
      const total=App.questions.reduce((s,q)=>s+q.pts,0);
      App.els.finalScore.textContent=`${App.score}/${total}`;
      App.els.qCard.classList.add("hidden");
      App.els.finish.classList.remove("hidden");
      setTimeout(()=>window.location.href="leaderboard.html",3500);
    }

    /* ===== Save & Exit (Ø§Ù„Ù…ØµÙ„Ø­Ø©) ===== */
    let isSubmitting=false;
    async function saveAndExit(){
      if(isSubmitting)return;
      isSubmitting=true;
      showLoading(true);
      Timer.stop();                       // Ø£ÙˆÙ‚Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯
      isPaused=true;                      // Ø¹Ù„Ù‘Ù‚ Ø§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø©
      // Ø­ÙØ¸ Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
      const progressSnapshot={
        currentQuestionIndex:App.idx,
        score:App.score,
        timeLeft:App.time,
        selectedAnswer:App.sel,
        completed:false,
        savedAt:new Date().toISOString()
      };
      sessionStorage.setItem('nafes_quiz_progress',JSON.stringify(progressSnapshot));
      // Ø­ÙØ¸ Ø³Ø­Ø§Ø¨ÙŠ (Ø¥Ù† Ø£Ù…ÙƒÙ†)
      try{
        if(typeof db!=='undefined'&&window.firebaseModules&&sessionId){
          const{setDoc,doc,serverTimestamp}=window.firebaseModules;
          await setDoc(doc(db,'quiz_sessions',sessionId),{...progressSnapshot,timestamp:serverTimestamp()},{merge:true});
        }
      }catch(e){console.warn('âš ï¸ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø³Ø­Ø§Ø¨ÙŠ');}
      // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù€ overlays + Ø¥Ø´Ø¹Ø§Ø± + ØªÙˆØ¬ÙŠÙ‡
      App.els.saveConf.classList.add("hidden");
      showLoading(false);
      showMessage('success','ğŸ’¾ ØªÙ… Ø­ÙØ¸ ØªÙ‚Ø¯Ù…Ùƒ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...');
      setTimeout(()=>{
        sessionStorage.setItem('resume','true');
        window.location.replace('index.html');
      },1500);
    }
    function hideSaveConfirmation(){App.els.saveConf.classList.add("hidden");}

    /* ========== Events ========== */
    document.addEventListener("click",e=>{
      if(e.target.closest(".option")&&!e.target.closest(".option").classList.contains("correct"))
        selectOption(e.target.closest(".option"));
    });
    App.els.submit.addEventListener("click",submit);
    App.els.next.addEventListener("click",next);
    App.els.skip.addEventListener("click",skip);
    App.els.saveExit.addEventListener("click",()=>App.els.saveConf.classList.remove("hidden"));
    document.getElementById("confirmSaveBtn").addEventListener("click",saveAndExit);
    document.getElementById("cancelSaveBtn").addEventListener("click",hideSaveConfirmation);
    document.addEventListener("keydown",e=>{
      if(App.completed)return;
      if(e.key==="Enter"&&App.sel!==null)submit();
      if(e.key==="Escape")skip();
      if(+e.key>=1&&+e.key<=4){
        const opt=document.querySelector(`[data-index="${+e.key-1}"]`);
        if(opt&&!opt.classList.contains("correct"))selectOption(opt);
      }
    });

    /* ========== Start ========== */
    (function init(){
      // Ø§Ø³ØªØ¦Ù†Ø§Ù Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ Ø¥Ù† ÙˆÙØ¬Ø¯
      const saved=sessionStorage.getItem('nafes_quiz_progress');
      if(saved){
        try{
          const p=JSON.parse(saved);
          App.idx=p.currentQuestionIndex||0;
          App.score=p.score||0;
          App.time=p.timeLeft||60;
          App.sel=p.selectedAnswer??null;
        }catch{}
      }
      App.questions=shuffle(bank);
      loadQuestion();
      setTimeout(()=>App.els.loading.classList.add("hidden"),600);
    })();
  </script>
</body>
</html>
