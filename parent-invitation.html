<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ù…ÙˆØ°Ø¬ Ø¯Ø¹ÙˆØ© Ø­Ø¶ÙˆØ± Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ± - Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</title>
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Cairo', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    min-height: 100vh;
    color: #333;
    line-height: 1.7;
    padding: 20px 0;
}

.main-container {
    max-width: 1000px;
    margin: 0 auto;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border-radius: 25px;
    box-shadow: 0 25px 80px rgba(0,0,0,0.2);
    overflow: hidden;
    position: relative;
}

.main-container::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    background: linear-gradient(90deg, #0d5c0d, #2d8f2d, #0d5c0d);
    animation: shimmer 3s ease-in-out infinite;
}

@keyframes shimmer {
    0%, 100% { opacity: 0.8; }
    50% { opacity: 1; }
}

/* Header Section */
.header-section {
    background: linear-gradient(135deg, #0d5c0d 0%, #1a7a1a 50%, #2d8f2d 100%);
    color: white;
    padding: 50px 30px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.header-section::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
    background-size: 30px 30px;
    animation: float 20s linear infinite;
}

@keyframes float {
    0% { transform: translate(-50px, -50px); }
    100% { transform: translate(-30px, -30px); }
}

.logo-section {
    position: relative;
    z-index: 2;
    margin-bottom: 30px;
}

.saudi-emblem {
    width: 100px;
    height: 100px;
    background: white;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 36px;
    margin-bottom: 20px;
    box-shadow: 0 15px 40px rgba(0,0,0,0.3);
    border: 3px solid rgba(255,255,255,0.9);
    position: relative;
    overflow: hidden;
}

.saudi-emblem::before {
    content: "";
    position: absolute;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, transparent 30%, rgba(0,150,0,0.1) 50%, transparent 70%);
    animation: shine 3s ease-in-out infinite;
}

@keyframes shine {
    0% { transform: translateX(-100%); }
    50% { transform: translateX(100%); }
    100% { transform: translateX(100%); }
}

.header-text {
    position: relative;
    z-index: 2;
}

.kingdom-name {
    font-size: 24px;
    font-weight: 700;
    margin-bottom: 12px;
    text-shadow: 2px 2px 6px rgba(0,0,0,0.3);
    letter-spacing: 1px;
}

.ministry-name {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 10px;
    opacity: 0.95;
    letter-spacing: 0.5px;
}

.office-name {
    font-size: 18px;
    font-weight: 500;
    margin-bottom: 10px;
    opacity: 0.9;
}

.school-name {
    font-size: 20px;
    font-weight: 700;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid rgba(255,255,255,0.4);
    letter-spacing: 0.5px;
}

/* Title Section */
.title-section {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    padding: 40px 30px;
    text-align: center;
    border-bottom: 1px solid #dee2e6;
}

.main-title {
    font-size: 36px;
    color: #0d5c0d;
    font-weight: 700;
    margin-bottom: 25px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    position: relative;
}

.main-title::after {
    content: "";
    width: 80px;
    height: 4px;
    background: linear-gradient(90deg, #0d5c0d, #2d8f2d);
    display: block;
    margin: 15px auto 0;
    border-radius: 2px;
}

.meeting-info {
    background: white;
    display: inline-block;
    padding: 25px 35px;
    border-radius: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: 1px solid #e9ecef;
}

.time-label {
    font-size: 16px;
    color: #666;
    margin-bottom: 8px;
    font-weight: 500;
}

.time-display {
    font-size: 24px;
    color: #0d5c0d;
    font-weight: 700;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* Form Section */
.form-section {
    padding: 50px 30px;
    background: white;
}

.form-container {
    max-width: 700px;
    margin: 0 auto;
}

.form-row {
    display: grid;
    gap: 30px;
    margin-bottom: 30px;
}

.form-group {
    position: relative;
}

.field-label {
    display: block;
    font-weight: 600;
    margin-bottom: 12px;
    color: #2c3e50;
    font-size: 16px;
    position: relative;
    padding-right: 12px;
}

.field-label::before {
    content: "â—„";
    position: absolute;
    right: 0;
    color: #0d5c0d;
    font-size: 12px;
    top: 2px;
}

.form-input, .form-select {
    width: 100%;
    padding: 18px 20px;
    border: 2px solid #e1e5e9;
    border-radius: 12px;
    font-size: 16px;
    font-family: inherit;
    background: #fafbfc;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    color: #2c3e50;
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: #0d5c0d;
    background: white;
    box-shadow: 0 0 0 4px rgba(13, 92, 13, 0.1);
    transform: translateY(-2px);
}

.form-select {
    cursor: pointer;
    appearance: none;
    background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%230d5c0d"><path d="M7 10l5 5 5-5z"/></svg>');
    background-repeat: no-repeat;
    background-position: left 15px center;
    background-size: 20px;
    padding-left: 50px;
}

.help-text {
    font-size: 14px;
    color: #6c757d;
    margin-top: 8px;
    padding: 10px 15px;
    background: linear-gradient(135deg, #f8f9fa, #f1f3f4);
    border-radius: 8px;
    border-left: 4px solid #0d5c0d;
    position: relative;
}

/* Excuse Section */
.excuse-section {
    background: linear-gradient(135deg, #fff8e1, #ffecb3);
    border: 2px solid #ffc107;
    border-radius: 16px;
    padding: 30px;
    margin: 30px 0;
    position: relative;
    overflow: hidden;
}

.excuse-section::before {
    content: "";
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(45deg, transparent, rgba(255, 193, 7, 0.05), transparent);
    animation: wave 4s linear infinite;
}

@keyframes wave {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.excuse-header {
    position: relative;
    z-index: 2;
}

.excuse-label {
    display: flex;
    align-items: center;
    cursor: pointer;
    font-size: 18px;
    font-weight: 600;
    color: #8a6914;
    transition: all 0.3s ease;
    user-select: none;
}

.excuse-label:hover {
    transform: translateX(5px);
    color: #6d5411;
}

.excuse-checkbox {
    width: 22px;
    height: 22px;
    margin-left: 15px;
    cursor: pointer;
    accent-color: #ffc107;
    transform: scale(1.2);
}

.excuse-details {
    margin-top: 25px;
    padding-top: 25px;
    border-top: 2px dashed #ffc107;
    display: none;
    position: relative;
    z-index: 2;
    animation: slideDown 0.5s ease;
}

.excuse-textarea {
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid #ffc107;
    min-height: 120px;
    resize: vertical;
    font-family: inherit;
    line-height: 1.6;
}

.excuse-textarea:focus {
    border-color: #e0a800;
    background: white;
    box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.1);
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
        max-height: 0;
    }
    to {
        opacity: 1;
        transform: translateY(0);
        max-height: 300px;
    }
}

/* Submit Section */
.submit-section {
    background: linear-gradient(135deg, #f8f9fa, #e9ecef);
    padding: 50px 30px;
    text-align: center;
}

.submit-button {
    background: linear-gradient(135deg, #0d5c0d 0%, #2d8f2d 100%);
    color: white;
    padding: 20px 60px;
    border: none;
    border-radius: 50px;
    font-size: 18px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(13, 92, 13, 0.3);
    text-transform: uppercase;
    letter-spacing: 1px;
    min-width: 250px;
}

.submit-button::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.2);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: all 0.6s ease;
}

.submit-button:hover::before {
    width: 300px;
    height: 300px;
}

.submit-button:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(13, 92, 13, 0.4);
}

.submit-button:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

/* Messages */
.message {
    padding: 25px;
    border-radius: 15px;
    text-align: center;
    font-size: 16px;
    margin-top: 25px;
    display: none;
    position: relative;
    overflow: hidden;
}

.success-message {
    background: linear-gradient(135deg, #d1edcc, #c3e6cb);
    border: 2px solid #28a745;
    color: #155724;
}

.success-message::before {
    content: "âœ“";
    display: block;
    font-size: 40px;
    margin-bottom: 15px;
    color: #28a745;
}

.error-message {
    background: linear-gradient(135deg, #f8d7da, #f5c6cb);
    border: 2px solid #dc3545;
    color: #721c24;
}

.error-message::before {
    content: "âš ";
    display: block;
    font-size: 40px;
    margin-bottom: 15px;
    color: #dc3545;
}

/* Footer */
.footer {
    background: #0d5c0d;
    color: white;
    text-align: center;
    padding: 30px 20px;
    font-size: 14px;
}

.footer-main {
    margin-bottom: 15px;
    opacity: 0.9;
}

.developer-credit {
    font-size: 12px;
    color: rgba(255,255,255,0.7);
    border-top: 1px solid rgba(255,255,255,0.2);
    padding-top: 15px;
}

/* Loading Animation */
.loading-spinner {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    border-top-color: #fff;
    animation: spin 1s ease-in-out infinite;
    margin-left: 10px;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Responsive Design */
@media (max-width: 768px) {
    .main-container {
        margin: 10px;
        border-radius: 20px;
    }

    .header-section {
        padding: 40px 20px;
    }

    .kingdom-name {
        font-size: 20px;
    }

    .main-title {
        font-size: 28px;
    }

    .form-section {
        padding: 40px 20px;
    }

    .submit-button {
        padding: 18px 40px;
        font-size: 16px;
    }

    .time-display {
        font-size: 20px;
    }
}

@media (max-width: 480px) {
    .meeting-info {
        padding: 20px 25px;
    }

    .saudi-emblem {
        width: 80px;
        height: 80px;
        font-size: 28px;
    }

    .main-title {
        font-size: 24px;
    }
}
</style>
</head>
<body>
<div class="main-container">
    <!-- Header Section -->
    <div class="header-section">
        <div class="logo-section">
            <div class="saudi-emblem">ğŸ‡¸ğŸ‡¦</div>
        </div>
        <div class="header-text">
            <div class="kingdom-name">Ø§Ù„Ù…Ù…Ù„ÙƒØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©</div>
            <div class="ministry-name">ÙˆØ²Ø§Ø±Ø© Ø§Ù„ØªØ¹Ù„ÙŠÙ…</div>
            <div class="office-name">Ù…ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹ÙˆØ§Ù„ÙŠ</div>
            <div class="school-name">Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ</div>
        </div>
    </div>

    <!-- Title Section -->
    <div class="title-section">
        <h1 class="main-title">Ù†Ù…ÙˆØ°Ø¬ Ø¯Ø¹ÙˆØ© Ø­Ø¶ÙˆØ± Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</h1>
        <div class="meeting-info">
            <div class="time-label">ÙˆÙ‚Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹</div>
            <div class="time-display">
                <span>12:30 - 1:00</span>
                <span>Ø¸Ù‡Ø±Ø§Ù‹</span>
            </div>
        </div>
    </div>

    <!-- Form Section -->
    <div class="form-section">
        <div class="form-container">
            <form id="parentForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="studentName" class="field-label">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</label>
                        <input type="text" id="studentName" name="studentName" class="form-input" 
                               placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„Ù„Ø·Ø§Ù„Ø¨" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="parentName" class="field-label">Ø§Ø³Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</label>
                        <input type="text" id="parentName" name="parentName" class="form-input" 
                               placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù„ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="phoneNumber" class="field-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
                        <input type="tel" id="phoneNumber" name="phoneNumber" class="form-input" 
                               placeholder="05xxxxxxxxx" pattern="[0-9]{10}" maxlength="10" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="meetingDay" class="field-label">Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø­Ø¶ÙˆØ±</label>
                        <select id="meetingDay" name="meetingDay" class="form-select" required>
                            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ --</option>
                        </select>
                        <div class="help-text">
                            <strong>Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ø³ØªØ¸Ù‡Ø± ÙƒØºÙŠØ± Ù…ØªØ§Ø­Ø©. Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ….
                        </div>
                    </div>
                </div>

                <div class="excuse-section">
                    <div class="excuse-header">
                        <label class="excuse-label">
                            <input type="checkbox" id="excuseCheckbox" class="excuse-checkbox">
                            <span>Ø£Ø¹ØªØ°Ø± Ø¹Ù† Ø§Ù„Ø­Ø¶ÙˆØ±</span>
                        </label>
                    </div>

                    <div class="excuse-details" id="excuseDetails">
                        <div class="form-group">
                            <label for="excuseReason" class="field-label">Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±</label>
                            <textarea id="excuseReason" name="excuseReason" class="form-input excuse-textarea" 
                                    rows="4" placeholder="ÙŠØ±Ø¬Ù‰ ØªÙˆØ¶ÙŠØ­ Ø³Ø¨Ø¨ Ø¹Ø¯Ù… Ø§Ù„Ù‚Ø¯Ø±Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø­Ø¶ÙˆØ±..."></textarea>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Submit Section -->
    <div class="submit-section">
        <button type="submit" form="parentForm" class="submit-button" id="submitBtn">
            ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±
        </button>

        <div class="success-message message" id="successMessage">
            <strong>ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!</strong><br>
            <span id="successDetails">Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.</span>
        </div>

        <div class="error-message message" id="errorMessage">
            <strong>Ø­Ø¯Ø« Ø®Ø·Ø£!</strong><br>
            <span id="errorDetails">ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</span>
        </div>
    </div>
</div>

<!-- Footer -->
<div class="footer">
    <div class="footer-main">
        Â© 1447Ù‡Ù€ - Ù…ØªÙˆØ³Ø·Ø© Ø§Ù„Ù…Ù†Ø°Ø± Ø¨Ù† Ø¹Ù…Ø±Ùˆ Ø§Ù„Ø£Ù†ØµØ§Ø±ÙŠ - Ù…ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ… Ø§Ù„Ø¹ÙˆØ§Ù„ÙŠ
    </div>
    <div class="developer-credit">
        ØªÙ†ÙÙŠØ° ÙˆØªØµÙ…ÙŠÙ… Nawaf Alsubhi 2025
    </div>
</div>

<!-- Firebase Scripts -->
<script type="module">
    // Firebase Configuration - Updated with new credentials
    const firebaseConfig = {
        apiKey: "AIzaSyDMkhB9tjAnWHBJo3pa7LHRGTfjLRg0yB4",
        authDomain: "nawafalsubhi3-f4abf.firebaseapp.com",
        projectId: "nawafalsubhi3-f4abf",
        storageBucket: "nawafalsubhi3-f4abf.firebasestorage.app",
        messagingSenderId: "409217413356",
        appId: "1:409217413356:web:d1e0dd6f584c66255875c9",
        measurementId: "G-BVP04DLPM9"
    };

    // Import Firebase modules
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js';

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const analytics = getAnalytics(app);

    console.log('Firebase initialized successfully');

    // Days Configuration
    const DAYS_CAPACITY = {
        sunday: { name: 'Ø§Ù„Ø£Ø­Ø¯', date: '15/3/1447Ù‡Ù€', max: 80 },
        monday: { name: 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', date: '16/3/1447Ù‡Ù€', max: 80 },
        tuesday: { name: 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', date: '17/3/1447Ù‡Ù€', max: 80 },
        wednesday: { name: 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡', date: '18/3/1447Ù‡Ù€', max: 80 },
        thursday: { name: 'Ø§Ù„Ø®Ù…ÙŠØ³', date: '19/3/1447Ù‡Ù€', max: 80 }
    };

    // Firebase Functions
    async function saveBookingToFirebase(bookingData) {
        try {
            console.log('Saving booking:', bookingData);
            const docRef = await addDoc(collection(db, 'bookings'), {
                ...bookingData,
                timestamp: serverTimestamp(),
                type: 'booking'
            });
            console.log('Booking saved with ID:', docRef.id);
            return true;
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø²:', error);
            return false;
        }
    }

    async function saveExcuseToFirebase(excuseData) {
        try {
            console.log('Saving excuse:', excuseData);
            const docRef = await addDoc(collection(db, 'bookings'), {
                ...excuseData,
                timestamp: serverTimestamp(),
                type: 'excuse'
            });
            console.log('Excuse saved with ID:', docRef.id);
            return true;
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±:', error);
            return false;
        }
    }

    async function getBookedCount(day) {
        try {
            const q = query(
                collection(db, 'bookings'), 
                where('selectedDay', '==', day),
                where('type', '==', 'booking')
            );
            const querySnapshot = await getDocs(q);
            return querySnapshot.size;
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
            return 0;
        }
    }

    async function isStudentAlreadyBooked(studentName) {
        try {
            const q = query(
                collection(db, 'bookings'), 
                where('studentName', '==', studentName)
            );
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±:', error);
            return false;
        }
    }

    // Update Day Options
    async function updateDayOptions() {
        const selectElement = document.getElementById('meetingDay');
        
        selectElement.innerHTML = '<option value="">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©...</option>';
        selectElement.disabled = true;

        try {
            selectElement.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ --</option>';

            const dayOptions = [
                { value: 'sunday', text: 'Ø§Ù„Ø£Ø­Ø¯ - 15/3/1447Ù‡Ù€' },
                { value: 'monday', text: 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ† - 16/3/1447Ù‡Ù€' },
                { value: 'tuesday', text: 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡ - 17/3/1447Ù‡Ù€' },
                { value: 'wednesday', text: 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡ - 18/3/1447Ù‡Ù€' },
                { value: 'thursday', text: 'Ø§Ù„Ø®Ù…ÙŠØ³ - 19/3/1447Ù‡Ù€' }
            ];

            for (const dayOption of dayOptions) {
                const option = document.createElement('option');
                option.value = dayOption.value;

                const bookedCount = await getBookedCount(dayOption.value);
                const available = DAYS_CAPACITY[dayOption.value].max - bookedCount;

                if (available <= 0) {
                    option.disabled = true;
                    option.textContent = dayOption.text + ' (Ù…ÙƒØªÙ…Ù„)';
                    option.style.color = '#dc3545';
                    option.style.background = '#f8d7da';
                } else if (available <= 10) {
                    option.textContent = dayOption.text + ` (Ù…ØªØ¨Ù‚ÙŠ: ${available} Ù…Ù‚Ø§Ø¹Ø¯)`;
                    option.style.color = '#856404';
                } else {
                    option.textContent = dayOption.text + ` (Ù…ØªØ§Ø­: ${available} Ù…Ù‚Ø¹Ø¯)`;
                }

                selectElement.appendChild(option);
            }

            selectElement.disabled = false;
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£ÙŠØ§Ù…:', error);
            selectElement.innerHTML = '<option value="">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙŠØ§Ù… - ÙŠØ±Ø¬Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©</option>';
        }
    }

    // Utility Functions
    function isValidSaudiPhone(phone) {
        return /^05[0-9]{8}$/.test(phone);
    }

    function showSuccess(isExcuse) {
        const successMsg = document.getElementById('successMessage');
        const successDetails = document.getElementById('successDetails');
        const errorMsg = document.getElementById('errorMessage');

        errorMsg.style.display = 'none';
        
        if (isExcuse) {
            successMsg.querySelector('strong').textContent = 'ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ø¹ØªØ°Ø§Ø±Ùƒ Ø¨Ù†Ø¬Ø§Ø­!';
            successDetails.textContent = 'Ù†Ù‚Ø¯Ø± ØªÙˆØ§ØµÙ„Ùƒ Ù…Ø¹Ù†Ø§. Ù†ØªÙ…Ù†Ù‰ Ù„Ùƒ Ø¯ÙˆØ§Ù… Ø§Ù„Ø¹Ø§ÙÙŠØ©.';
        } else {
            successMsg.querySelector('strong').textContent = 'ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø­Ø¶ÙˆØ±Ùƒ Ø¨Ù†Ø¬Ø§Ø­!';
            successDetails.textContent = 'Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ø§Ù‹ Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.';
        }

        successMsg.style.display = 'block';
        successMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });

        setTimeout(() => {
            successMsg.style.display = 'none';
        }, 7000);
    }

    function showError(message) {
        const errorMsg = document.getElementById('errorMessage');
        const errorDetails = document.getElementById('errorDetails');
        const successMsg = document.getElementById('successMessage');
        
        successMsg.style.display = 'none';
        errorDetails.textContent = message;
        errorMsg.style.display = 'block';
        errorMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        setTimeout(() => {
            errorMsg.style.display = 'none';
        }, 5000);
    }

    // Form Handling
    document.getElementById('parentForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.textContent;
        
        // Disable button during submission
        submitBtn.disabled = true;
        submitBtn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„... <span class="loading-spinner"></span>';

        const studentName = document.getElementById('studentName').value.trim();
        const parentName = document.getElementById('parentName').value.trim();
        const phoneNumber = document.getElementById('phoneNumber').value.trim();
        const excuseCheckbox = document.getElementById('excuseCheckbox');
        const excuseReason = document.getElementById('excuseReason').value.trim();
        const meetingDay = document.getElementById('meetingDay').value;

        try {
            // Validation
            if (!studentName || !parentName || !phoneNumber) {
                throw new Error('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.');
            }

            if (!isValidSaudiPhone(phoneNumber)) {
                throw new Error('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ø³Ø¹ÙˆØ¯ÙŠ ØµØ­ÙŠØ­ (ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…).');
            }

            if (await isStudentAlreadyBooked(studentName)) {
                throw new Error('Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹.');
            }

            if (excuseCheckbox.checked) {
                // Excuse case
                if (!excuseReason) {
                    throw new Error('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±.');
                }

                const excuseData = {
                    studentName,
                    parentName,
                    phoneNumber,
                    excuseReason,
                    submittedAt: new Date().toLocaleString('ar-SA')
                };

                const success = await saveExcuseToFirebase(excuseData);
                if (!success) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                }

                showSuccess(true);
                document.getElementById('parentForm').reset();
                document.getElementById('excuseDetails').style.display = 'none';
            } else {
                // Booking case
                if (!meetingDay) {
                    throw new Error('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ… Ù„Ù„Ø­Ø¶ÙˆØ±.');
                }

                const bookedCount = await getBookedCount(meetingDay);
                if (bookedCount >= DAYS_CAPACITY[meetingDay].max) {
                    throw new Error('Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± Ù…ÙƒØªÙ…Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ… Ø¢Ø®Ø±.');
                }

                const bookingData = {
                    studentName,
                    parentName,
                    phoneNumber,
                    selectedDay: meetingDay,
                    selectedDayName: DAYS_CAPACITY[meetingDay].name + ' - ' + DAYS_CAPACITY[meetingDay].date,
                    submittedAt: new Date().toLocaleString('ar-SA')
                };

                const success = await saveBookingToFirebase(bookingData);
                if (!success) {
                    throw new Error('ÙØ´Ù„ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø­Ø¬Ø². ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                }

                showSuccess(false);
                document.getElementById('parentForm').reset();
                updateDayOptions(); // Refresh available days
            }

        } catch (error) {
            showError(error.message);
        } finally {
            // Re-enable button
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        }
    });

    // Excuse checkbox handling
    document.getElementById('excuseCheckbox').addEventListener('change', function() {
        const excuseDetails = document.getElementById('excuseDetails');
        const meetingDaySelect = document.getElementById('meetingDay');
        const excuseReasonTextarea = document.getElementById('excuseReason');
        const submitBtn = document.getElementById('submitBtn');

        if (this.checked) {
            excuseDetails.style.display = 'block';
            meetingDaySelect.value = '';
            meetingDaySelect.disabled = true;
            meetingDaySelect.style.opacity = '0.5';
            meetingDaySelect.removeAttribute('required');
            submitBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±';
            submitBtn.style.background = 'linear-gradient(135deg, #ffc107, #e0a800)';
            submitBtn.style.color = '#000';
            excuseReasonTextarea.setAttribute('required', 'required');
        } else {
            excuseDetails.style.display = 'none';
            meetingDaySelect.disabled = false;
            meetingDaySelect.style.opacity = '1';
            meetingDaySelect.setAttribute('required', 'required');
            submitBtn.textContent = 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¶ÙˆØ±';
            submitBtn.style.background = 'linear-gradient(135deg, #0d5c0d 0%, #2d8f2d 100%)';
            submitBtn.style.color = 'white';
            excuseReasonTextarea.removeAttribute('required');
            excuseReasonTextarea.value = '';
        }
    });

    // Phone number formatting
    document.getElementById('phoneNumber').addEventListener('input', function() {
        let value = this.value.replace(/\D/g, '');

        if (value.length > 0 && !value.startsWith('05')) {
            if (value.startsWith('5')) {
                value = '0' + value;
            } else if (!value.startsWith('0')) {
                value = '05' + value;
            }
        }

        this.value = value.substring(0, 10);
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        updateDayOptions();
        
        // Add input animations
        const inputs = document.querySelectorAll('.form-input, .form-select');
        inputs.forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.style.transform = 'scale(1.02)';
            });

            input.addEventListener('blur', function() {
                this.parentElement.style.transform = 'scale(1)';
            });
        });
    });

</script>
</body>
</html>
